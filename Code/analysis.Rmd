---
title: 'Respiratory viruses and school absenteeism: a longitudinal field study'
author: "David Kronthaler"
date: "2024-05-17"
output:
  word_document:
    toc: true
  pdf_document:
    toc: true
  html_document:
    fig_caption: true
    code_folding: hide
    highlight: tango
    theme: yeti
    toc: true
    toc_float: true
header-includes: \usepackage{setspace}
editor_options:
  chunk_output_type: console
---

```{r Setup, include=FALSE}
## Setup #----------------------------------------------------------------------
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
set.seed(5)

# Packages #--------------------------------------------------------------------
require(tidyverse)
require(patchwork)
require(multcomp)
require(ggrepel)
require(gridExtra)
require(grid)
require(reshape2)
require(DescTools)
require(wesanderson)
require(flexsurv)
require(cowplot)
# #devtools::install_github("ricardo-bion/ggradar", dependencies = TRUE)
require(ggradar)
require(tableone)

# Setup for coloring #----------------------------------------------------------
# Respiratory viruses levels
pathgs <- c("IFA", "IFB", "HRV", "AdV", "PIV", "RSV", "HCoV-OC43", "HCoV-229E")
cols <- wes_palette("IsleofDogs1")
cols <- c(
  wes_palette("Rushmore1")[3],
  cols[-c(4, 5)],
  wes_palette("GrandBudapest2")[4],
  wes_palette("FantasticFox1")[c(4, 5)]
)
names(cols) <- pathgs

# Respiratory viruses labels
pathgs.labels <- c("IAV", "IBV", "HRV", "AdV", "PIV", "RSV", "HCoV-OC43","HCoV-229E")
cols.labels <- cols
names(cols.labels) <- pathgs.labels

# Language settings #-----------------------------------------------------------
Sys.setlocale("LC_TIME", "en_US.UTF-8")

# Load data #-------------------------------------------------------------------
# Data: Recorded school absences
abs_sus <- read.csv("../data-clean/redcap/absences_sus.csv")
# Data: Saliva samples
sal_res <- read.csv("../data-clean/molecular/positive-saliva-student-list.csv")
test_res <- read.csv("../data-clean/molecular/saliva-results.csv")
# Data: Social survey
soc_res <- readRDS("../data-clean/survey/social-survey-results.rds")

# Data: Imputed data for linked infections and absences
infections_imp <- readRDS("../data-imputed/linked-infections-absences.rds") %>%
  mutate(
    pathogen = factor(pathogen, levels = pathgs)
  )

# Source functions #------------------------------------------------------------
source("../utils/fct_descr_analysis.R")

# Source data preparation #-----------------------------------------------------
source("../utils/dataprep_descr_analysis.R")
```


# Table 1: Description of study population

```{r Table 1}
## Frequency of students by sex and class 
##------------------------------------------------------------------------------
soc_res %>%
  filter(time == "Baseline", student_id %in% test_res$student_id) %>%
  mutate(Class = factor(substr(student_id, 1, 1), 
                        levels = c("A", "B", "C", "D"),
                        labels = c("Class 1", "Class 2", "Class 3", "Class 4"))) %>%
  dplyr::select(sex, Class) %>%
  CreateTableOne(.,vars = c("sex"), strata = "Class", 
                 test = FALSE,  addOverall = TRUE)

## Frequency and type of school absences 
##------------------------------------------------------------------------------
CreateTableOne(
  data = abs_sus %>%
    filter(student_id %in% test_res$student_id) %>%
    mutate(symp_respir = as.factor(symp_respir),
           class = factor(substr(student_id, 1, 1),
                          levels = c("A", "B", "C", "D"),
                          labels = c("Class 1", "Class 2", "Class 3", "Class 4")),
           sick_with_resp = as.factor(if_else(reason == "sickness" & 
                                                symp_respir == 1, 1, 0)),
           sick_wo_resp = as.factor(if_else(reason == "sickness" & 
                                              symp_respir == 0, 1, 0)),
           other_vocal = as.factor(if_else(reason == "other" | 
                                             reason == "vocational", 1, 0))),
  strata = "class", addOverall = TRUE,
  vars = c("sick_with_resp", "sick_wo_resp", "other_vocal"), test = FALSE)

## Frequency of positive saliva tests 
##------------------------------------------------------------------------------
CreateTableOne(
  data = viral_loads %>%
    dplyr::select(student_id, pathogen) %>%
    mutate(pathogen = factor(pathogen, levels = pathgs),
           class = factor(substr(student_id, 1, 1))),
  strata = "class", vars = c("pathogen"),
  addOverall = TRUE, test = FALSE)

## Frequency of positive students 
##------------------------------------------------------------------------------
nrow(viral_loads %>%
     dplyr::select(student_id) %>% distinct())
viral_loads %>%
 mutate(class = factor(substr(student_id, 1, 1))) %>%
 group_by(class) %>%
 summarise(distinct_students = n_distinct(student_id)) %>%
 ungroup() %>%
 as.data.frame() %>%
 `rownames<-`(NULL)

## Frequency of tests by class 
##------------------------------------------------------------------------------
test_res %>%
  filter(absent == FALSE & !is.na(pathogen_1)) %>%
  group_by(class) %>%
  summarise(n = n()) %>%
  ungroup()
```


# Figure 1: Distribution of positive saliva tests and positivity periods

```{r warning=FALSE, message=FALSE}
## Distribution of positive saliva tests and positivity periods #---------------
# Positive saliva tests
figure_1_a <- viral_loads %>%
  group_by(pathogen) %>%
  summarise(n = n()) %>%
  mutate(csum = rev(cumsum(rev(n))),
         pos = n/2 + lead(csum, 1) + 0.1,
         pos = if_else(is.na(pos), n/2, pos)) %>%
  ggplot(aes(x = "" , y = n, fill = pathogen)) +
  geom_col(width = 1, color = 1, alpha = 0.7) +
  coord_polar(theta = "y") +
  scale_fill_manual(values = cols) +
  geom_text_repel(aes(x = 1.48, y = pos, 
                    label = pathgs.labels),
                size = 3, nudge_x = 0.36, show.legend = FALSE,
                segment.size = 0.5, segment.color = "black",
                direction = "y") +
  geom_text(aes(y = pos, label = paste0(n, " (", round(n/sum(n) * 100,
                                     0),  "%)")),
            size = 2.2, nudge_x = 0.32, show.legend = FALSE) +
  labs(
    caption = "Number (%) of positive tests",
    title = "a"
  ) +
  theme_void() +
    theme(
    legend.position = "none",
    legend.title = element_blank(),
    plot.margin = margin(0, 0, 10, 0),
    plot.caption = element_text(hjust = 0.5, 
                                vjust = 10, size = 8, 
                                margin = margin(t = 10),
                                face = "plain"),
    title = element_text(size = 8, face = "bold"))

# Positivity periods
figure_1_b <- pos_periods %>% 
  filter(!is.na(pathogen)) %>%
  group_by(infection_id) %>%
  slice(1) %>% 
  ungroup() %>%
  group_by(pathogen) %>%
  summarise(n = n()) %>%
  mutate(csum = rev(cumsum(rev(n))),
         pos = n/2 + lead(csum, 1) + 0.1,
         pos = if_else(is.na(pos), n/2, pos)) %>%
  ggplot(aes(x = "" , y = n, fill = pathogen)) +
  geom_col(width = 1, color = 1, alpha = 0.7) +
  coord_polar(theta = "y") +
  scale_fill_manual(values = cols) +
  geom_text_repel(aes(x = 1.48, y = pos, label = pathgs.labels),
                   size = 3, nudge_x = 0.36, show.legend = FALSE,
                   segment.size = 0.5, segment.color = "black",
                   direction = "y") +
  geom_text(aes(y = pos, 
                label = paste0(n, " (", round(n / sum(n) * 100, 0),
                                    "%)")),
            size = 2.2, nudge_x = 0.28, show.legend = FALSE) +
  labs(
    caption = "Number (%) of infection episodes",
    title = "b"
  ) +
  theme_void() +
  theme(
    legend.position = "none",
    legend.title = element_blank(),
    plot.margin = margin(0, 0, 10, 0),
    plot.caption = element_text(hjust = 0.5, 
                                vjust = 10, size = 8, 
                                margin = margin(t = 10),
                                face = "plain"),
    title = element_text(size = 8, face = "bold"))


## Save Figure 1 #-------------------------------------------------------------
jpeg("../../mcid3_DK/Draft/figure1.jpeg", width = 16, height = 10, units = 'cm', 
     res = 1000)
figure_1_a + figure_1_b +
  plot_layout(guides = "collect") & 
  theme(legend.position = "none",
        legend.key.size = ggplot2::unit(0.4,"cm"))
dev.off()

# Save Figure 1 as .tif with dpi = 300
tiff("../../mcid3_DK/Draft/after_review/figures_tif/figure1.tif", width = 16, height = 10, units = 'cm', 
     res = 300)
figure_1_a + figure_1_b +
  plot_layout(guides = "collect") & 
  theme(legend.position = "none",
        legend.key.size = ggplot2::unit(0.4,"cm"))
dev.off()
```
Â¨

# Figure 2: Temporal distribution of positive saliva tests overall and by class

```{r}
## Positive saliva tests over time #--------------------------------------------
# Dates for x-axis
days_plot <- c(unique(viral_loads$date)[order(unique(viral_loads$date))][1:6], 
               "2024-02-07", 
               unique(viral_loads$date)[order(unique(viral_loads$date))][7:18]) %>%
  as.Date(origin = "1970-01-01") %>%
  format("%b %d")
days_plot[is.na(days_plot)] <- ""

## Figure 2a: Overall #---------------------------------------------------------
figure_2_a <- viral_loads %>%
  mutate(class_id = substr(student_id, 1, 1),
         pathogen  = factor(pathogen, 
                            levels = rev(pathgs),
                            labels = rev(pathgs.labels)
                            ),
         time_id = ifelse(as.numeric(time_id) > 6,
                                     as.numeric(time_id) + 1,
                                     as.numeric(time_id))) %>%
  group_by(time_id, pathogen) %>%
  summarize(no_inf = n()) %>%
  bind_rows(data.frame(time_id = 7, 
                       pathogen = NA, 
                       no_inf = 0)) %>%
  ggplot(aes(x = time_id, y = no_inf, fill = pathogen)) +
    geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c(rev(cols.labels)),
                    na.translate = FALSE) +
  labs(
    x = "", y = "",
    title = "a"
  ) +
  scale_x_continuous(breaks = 1:19, labels = days_plot) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
    legend.title = element_blank(),
    title = element_text(size = 8, face = "bold"),
    panel.grid.minor.x = element_blank(),
    legend.position = "bottom") + 
  annotate("rect", xmin = 6.5, 
           xmax = 7.5,
           ymin = 0, ymax = Inf,
           fill = "darkgray", alpha = 0.5)+
  # add vertical text in box
  annotate("text", x = 7, y = 13, 
           label = "1-week vacation", 
           vjust = 0.5, hjust = 0.8, color = "black",
           size = 3, angle = 90) +
  guides(fill = guide_legend(nrow =1, reverse = TRUE))

## Figure 2b: Stratified by Class #---------------------------------------------
figure_2_b <- viral_loads %>%
  mutate(class_id = as.factor(paste("Class", substr(student_id, 1, 1))),
         pathogen  = factor(pathogen, levels = rev(pathgs),
                            labels = rev(pathgs.labels)
                            ),
         time_id = ifelse(as.numeric(time_id) > 6,
                          as.numeric(time_id) + 1,
                          as.numeric(time_id))) %>%
  group_by(time_id, pathogen, class_id) %>%
  summarize(no_inf = n(), .groups = 'drop') %>%
  bind_rows(expand.grid(time_id = 7, 
                        pathogen = NA, 
                        no_inf = 0, 
                        class_id = unique(paste("Class", substr(viral_loads$student_id, 1, 1))))) %>%
  mutate(class_id = recode_factor(class_id,
                                  "Class A" = "Class 1",
                                  "Class B" = "Class 2",
                                  "Class C" = "Class 3",
                                  "Class D" = "Class 4")) %>%
  ggplot(aes(x = time_id, y = no_inf, fill = pathogen)) +
  facet_wrap(~class_id) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c(rev(cols.labels)),
                    na.translate = FALSE) +
  labs(
    x = "", y = "",
    title = "b"
  ) +
  scale_x_continuous(breaks = c(1:19)[seq(1, 19, by = 2)],
                     labels = days_plot[seq(1, 19, by = 2)]) + 
  scale_y_continuous(breaks = c(0, 5, 10), expand = c(0, 0),
                     labels = c(0, 5, 10)) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
    legend.title = element_blank(),
    legend.position = "bottom",
    title = element_text(size = 8, face = "bold"),
    strip.text = element_text(size = 8, face = "plain", vjust = 1),
    strip.background = element_blank(),
    panel.grid.minor.x = element_blank()
    ) +
  annotate("rect", xmin = 6.5, 
           xmax = 7.5,
           ymin = 0, ymax = 10,
           fill = "darkgray", alpha = 0.5) +
  annotate("text", x = 7, y = 8, 
           label = "1-week vacation", 
           vjust = 0.42, hjust = 1, color = "black",
           size = 2.75, angle = 90) +
  guides(fill = guide_legend(nrow =1, reverse = TRUE)) +
  geom_hline(yintercept = 0)


## Save Figure 2 #--------------------------------------------------------------
figure_2 <- (figure_2_a / figure_2_b ) + 
  plot_layout(guides = "collect", axis_title = "collect",
              heights = c(1,1)) &
  theme(legend.position = "bottom",
        legend.key.size = ggplot2::unit(0.4,"cm"),
        legend.text = element_text(size = 8),
        plot.margin = ggplot2::unit(c(0,0,0,-0.2), "cm"),
        )
y_axis_title <- ggdraw() + draw_label("Number of positive tests", 
                                      angle = 90, vjust = 0.8,
                                      size = 8)
jpeg("../../mcid3_DK/Draft/figure2.jpeg", width = 18, height = 20, units = 'cm',
     res = 1000)
plot_grid(y_axis_title, figure_2, 
          ncol = 2, 
          rel_widths = c(0.05, 1))
dev.off()

# Save as .tif
tiff("../../mcid3_DK/Draft/after_review/figures_tif/figure2.tif", width = 18, height = 20, units = 'cm',
     res = 300)
plot_grid(y_axis_title, figure_2, 
          ncol = 2, 
          rel_widths = c(0.05, 1))
dev.off()
```


## Supplements: Temporal distribution of positive saliva tests by gender

```{r}
## Temporal distribution of positive saliva tests by gender #-------------------
spatialD_gender <- viral_loads %>%
  mutate(class_id = substr(student_id, 1, 1),
         pathogen  = factor(pathogen, levels = rev(pathgs),
                            labels = rev(pathgs.labels)),
         time_id = ifelse(as.numeric(time_id) > 6,
                          as.numeric(time_id) + 1,
                          as.numeric(time_id))) %>%
  group_by(time_id, pathogen, gender) %>%
  summarize(no_inf = n(), .groups = 'drop') %>%
  bind_rows(data.frame(time_id = 7, 
                       pathogen = NA, 
                       no_inf = 0, 
                       gender = unique(viral_loads$gender))) %>%
  mutate(gender = recode_factor(gender, "female" = "Female",
                                "male" = "Male")) %>%
  ggplot(aes(x = time_id, y = no_inf, fill = pathogen)) +
  facet_wrap(~gender) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c(rev(cols.labels)),
                    na.translate = FALSE) +
  labs(
    x = "", y = "",
    title = ""
  ) +
  scale_x_continuous(breaks = c(1:19)[seq(1, 19, by = 2)],
                     labels = days_plot[seq(1, 19, by = 2)]) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
    legend.title = element_blank(),
    legend.position = "bottom",
    title = element_text(size = 8, face = "bold"),
    strip.text = element_text(size = 8, face = "plain", vjust = 1),
    # remove strip label box
    strip.background = element_blank(),
    panel.grid.minor.x = element_blank(),
    legend.key.size = ggplot2::unit(0.4,"cm")
  ) +
  annotate("rect", xmin = 6.5, 
           xmax = 7.5,
           ymin = 0, ymax = Inf,
           fill = "darkgray", alpha = 0.5) +
  annotate("text", x = 7, y = 11.5, 
           label = "1-week vacation", 
           vjust = 0.45, hjust = 1, color = "black",
           size = 2.75, angle = 90) +
  guides(
    fill = guide_legend(nrow = 1, reverse = TRUE)
  )

jpeg("../../mcid3_DK/Draft/spatialDistribution_gender.jpeg",
     width = 16, height = 10, units = "cm",
     res = 1000
)
spatialD_gender
dev.off()
```

## Supplements: Barplot and comparisons of Ct-values across pathogens

```{r echo=FALSE, include=FALSE}
## Overall viral load (median [IQR])
##------------------------------------------------------------------------------
infections_imp %>%
  filter(!is.na(infection_id)) %>%
  group_by(infection_id) %>%
  slice(1) %>%
  ungroup() %>%
  # Extract minimal ct value per positivity period
  mutate(
    ct_min = sapply(salivas, function(x) min(as.numeric(unlist(x["ct"]))))
  ) %>%
  summarise(
    median_ct = median(ct_min), ct_q1 = quantile(ct_min, 0.25), ct_q3 = quantile(ct_min, 0.75),
  )

## Errorbar plot for Ct-values including standard errors #----------------------
CT_barplot <- infections_imp %>%
  filter(!is.na(infection_id)) %>%
  group_by(infection_id) %>%
  slice(1) %>%
  ungroup() %>%
  # Extract minimal ct value per positivity period
  mutate(
    ct_min = sapply(salivas, function(x) min(as.numeric(unlist(x["ct"]))))
  ) %>%
  # Plot
  group_by(pathogen) %>%
  summarise(
    median_ct = median(ct_min), ct_q1 = quantile(ct_min, 0.25), ct_q3 = quantile(ct_min, 0.75),
  ) %>%
  ungroup() %>%
  mutate(pathogen = factor(pathogen, levels = pathgs, labels = pathgs.labels)) %>%
  ggplot(aes(
    x = pathogen,
    y = median_ct,
    color = pathogen
  )) +
  geom_point(size = 2) +
  geom_errorbar(
    aes(
      ymin = ct_q1,
      ymax = ct_q3
    ),
    width = 0.2,
    linewidth = 1
  ) +
  scale_color_manual(values = cols.labels) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(
    y = "Viral load (Ct value)", title = "a"
  ) +
  coord_cartesian(ylim = c(25,40)) +
  theme_classic() +
  theme(
    axis.title.x = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 8),
    title = element_text(size = 8, face = "bold"),
    axis.title.y = element_text(size = 8, face = "plain"),
    
  )

## Modeling Ct-values #---------------------------------------------------------
# using linear regression on respiratory virus adjusted for gender
# considering only lowest Ct value per positivity period
ct.mod <- lm(ct_min ~ pathogen + sex, data = infections_imp %>%
  filter(!is.na(pathogen)) %>%
  group_by(infection_id) %>%
  slice(1) %>%
  ungroup() %>%
  # Extract minimal ct value per positivity period
  mutate(
    ct_min = sapply(salivas, function(x) min(as.numeric(unlist(x["ct"]))))
  ) %>%
  left_join(soc_res %>% filter(time == "Baseline") %>%
              dplyr::select(student_id, sex), by = "student_id"))
# F-test
anova(ct.mod)
         
# Posthoc tests using linear contrasts
posthoc <- glht(ct.mod, linfct = mcp(pathogen = "Tukey"))
posthoc.sum <- summary(posthoc, test = adjusted("none"))

# Extract differences
CT_diff <- as.data.frame(posthoc.sum$test$coefficients) %>%
  rename(diff = `posthoc.sum$test$coefficients`) %>%
  mutate(p_value = posthoc.sum$test$pvalues)

# Data for heatmap of Ct differences below
CT_diff <- CT_diff %>%
  mutate(
    pathogen_1 = str_split(rownames(CT_diff), " - ",
                           simplify = T)[, 1],
    pathogen_2 = str_split(rownames(CT_diff), " - ",
                           simplify = T)[, 2],
    sign = sapply(CT_diff$p_value, signif_code),
    diff_sign = as.character(paste0(round(CT_diff$diff, 1),
                                    sign))
  ) %>%
  arrange(match(pathogen_1, c("HCoV-229E", "HCoV-OC43", "RSV",
                              "PIV", "AdV", "HRV", "IFB")))
## Heatmap of pairwise comparisons in Ct-values #-------------------------------
Ct_heatmap <- CT_diff %>%
  mutate(
    pathogen_1 = factor(pathogen_1,
                        levels = pathgs,
                        labels = pathgs.labels),
    pathogen_2 = factor(pathogen_2,
                        levels = pathgs,
                        labels = pathgs.labels)) %>%
  ggplot(aes(x = pathogen_1, y = pathogen_2)) +
  geom_tile(aes(fill = diff), color = "white") +
  scale_fill_gradient2(
    low = "#1E90FF", mid = "#D3D3D3",
    high = "#FF3030", midpoint = 0,
    name = "Mean difference in Ct value   ",
    breaks = c(6,4,2,0,-2,-4, 6),
  ) +
  geom_text(aes(label = diff_sign), size = 2.8) +
  theme_minimal(base_size = 14) +
  labs(x = "", y = "",
       title = "b") +
  theme(
    axis.text.x = element_text(size = 8, angle = 0, hjust = 0.5),
    axis.text.y = element_text(size = 8, margin = margin(r = -5)),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.key.size = ggplot2::unit(0.8, "cm"),
    legend.title = element_text(size = 8, face = "plain"),
    legend.text = element_text(size = 8),
    title = element_text(size = 8, face = "bold"),
    plot.margin = margin(0, 0, 0, 0)
  )

## Save Supplementary Figure #--------------------------------------------------
jpeg("../../mcid3_DK/Draft/S1_CT.jpeg",
     width = 18, height = 22, units = "cm",
     res = 1000)
CT_barplot / plot_spacer() / Ct_heatmap +
  plot_layout(heights = c(1,0.02,1))
  theme(plot.margin = margin(0, -5, 0, 0))
dev.off()
```


## Comparison of length of absence periods with and without respiratory virus

Consider reporting IQR of absence periods instead of median with 95% CI.

```{r}
## Length of absence periods #--------------------------------------------------
surv_absences <- infections_imp %>%
  mutate(
    group = factor(case_when(
      is.na(pathogen) ~ "No pathogen",
      TRUE ~ "Pathogen"
  ), levels = c("No pathogen", "Pathogen")),
  absence_time = as.numeric(difftime(date_return, date_absent, units = "days")),
  # Account for interval censoring due to weekends/holidays
  possible = case_when(
    date_return %in% Mondays[,1] ~ -2,
    date_return == "2024-02-12" ~ -7,
    TRUE ~ 0
  )
) %>% as.data.frame()

par_abs_novsyespathog <- flexsurvreg(Surv(absence_time + possible, absence_time, 
                                          type = "interval2") ~ group, 
                                          data = surv_absences %>%
                                       filter(!is.na(absence_time)),
                                          dist = "gompertz")

tidy(par_abs_novsyespathog, conf.int = TRUE, transform = "coefs.exp") # p-values
predict(par_abs_novsyespathog, conf.int = T,  type = "quantile", p = 0.5,
        newdata = data.frame(group = c("No pathogen", "Pathogen")))
predict(par_abs_novsyespathog,  type = "quantile", p = 0.25,
        newdata = data.frame(group = c("No pathogen", "Pathogen")))
predict(par_abs_novsyespathog,  type = "quantile", p = 0.75,
        newdata = data.frame(group = c("No pathogen", "Pathogen")))
  
```

## Supplements: Boxplot for absence times due to respiratory infections

```{r}
## Boxplot of length of absence periods #---------------------------------------
boxplot_absences <- infections_imp %>%
  filter(!is.na(infection_id)) %>%
  mutate(
    absence_time = as.numeric(difftime(date_return, date_absent, units = "days")),
    absence_time = case_when(
    is.na(absence_time) ~ 0,
    TRUE ~ absence_time
  ),
  pathogen = factor(pathogen, levels = pathgs,
                    labels = pathgs.labels)) %>%
  ggplot(aes(x = pathogen, y = absence_time)) +
  geom_boxplot(fill = cols) +
  labs(
    x = "", 
    y = "Absence period (days)",
    title = ""
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 0, 
                               hjust = 0.5, 
                               size = 8),
    axis.title.y = element_text(size = 8, face = "plain"),
    title = element_text(size = 8, face = "bold"),
    legend.position = "none",
    plot.margin = margin(5,5,5,5)
  ) +
  scale_y_continuous(breaks = seq(0, 15, by = 2))
jpeg("../../mcid3_DK/Draft/S3_boxplot_absences.jpeg",
     width = 16, height = 10, units = "cm",
     res = 1000
)
boxplot_absences
dev.off()
```


# Figure 3b: Proportion of positivity periods with absences

```{r}
## Proportion of absences for viruses without IFB
##------------------------------------------------------------------------------
infections_imp %>%
    filter(!is.na(pathogen)) %>%
    group_by(infection_id) %>%
    slice(1) %>%
    ungroup() %>%
    mutate(
        absence_time = as.numeric(difftime(date_return, date_absent, units = "days")),
        absence = case_when(
            absence_time > 0 ~ "yes",
            TRUE ~ "no"
        )
    ) %>% filter(!(pathogen %in% c("IFB"))) %>%
    summarise(
        N = n(),
        n = sum(absence == "yes"),
        prop = n/N,
        co = BinomCI(x = n, n = N, method = "wilson", conf.level = 0.95)
    ) 
```

```{r}
figure_3b <- infections_imp %>%
  filter(!is.na(pathogen)) %>%
  group_by(infection_id) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    absence_time = as.numeric(difftime(date_return, date_absent, units = "days")),
    absence = case_when(
      absence_time > 0 ~ "yes",
      TRUE ~ "no"
    )
  ) %>%
  group_by(pathogen) %>%
  summarise(
    N = n(),
    n = sum(absence == "yes"),
    prop = n/N
  ) %>%
  mutate(lwr = BinomCI(x = n, n = N,
                       method = "wilson", conf.level = 0.95)[,2],
         upr = BinomCI(x = n, n = N,
                       method = "wilson", conf.level = 0.95)[,3],
         pathogen = factor(pathogen, levels = pathgs,
                           labels = pathgs.labels)) %>%
  ggplot(aes(x = pathogen, y = prop, col = pathogen)) +
  # Add errorbars
  geom_errorbar(aes(ymin = lwr, ymax = upr),
                width = 0.4, size =1) +
  # Add estimates of CI boundaries above/below errorbars
  geom_text(aes(y = upr + 0.045001, label = round(upr * 100, 0)), size = 3.2) +
  geom_text(data = .%>% filter(!(pathogen %in% c("IFB", "HCoV-229E"))),
            aes(y = lwr - 0.045001, label = round(lwr * 100, 0)), size = 3.2) +
  # geom_point(size = 3) +
  geom_tile(aes(width = 0.4, height = 0.09), 
            size = 0.9,
            fill = "white", color = cols) +
  # Add point estimates within squares
  geom_text(aes(label = round(prop * 100, 0)), size = 3.2) +
  scale_color_manual(values = cols.labels) +
  theme_classic() +
  labs(
    x = "", y = "Infections with absences (%)",
    title = "b"
  ) +
  theme(
    axis.text.x = element_text(size = 8, angle = 0, hjust = 0.5),
    axis.title.y = element_text(size = 8, face = "plain"),
    legend.position = "none",
    title = element_text(size = 8, face = "bold")
  ) +
  scale_y_continuous(limits = c(-0.045, 1.045), 
                     breaks = seq(0, 1, by = 0.2), 
                     labels = paste0(seq(0, 100, by = 20), "%"))
```

```{r}
## Comparison of proportion of absences across pathogens w/pairwise RDs
##------------------------------------------------------------------------------
abs_tab <- infections_imp %>%
    filter(!is.na(pathogen)) %>%
    group_by(infection_id) %>%
    slice(1) %>%
    ungroup() %>%
    mutate(
        absence_time = as.numeric(difftime(date_return, date_absent, units = "days")),
        absence = factor(case_when(
            absence_time > 0 ~ "yes",
            TRUE ~ "no"
        ), levels = c("no", "yes"))) %>%
  dplyr::select(pathogen, absence) %>% table()


pathogens <- rownames(abs_tab)
risk_diff_results <- data.frame(Pathogen1 = character(), Pathogen2 = character(),
                                RiskDifference = numeric(),
                                CI_Lower = numeric(), CI_Upper = numeric(),
                                p_value = numeric(), stringsAsFactors = FALSE)

for (i in 1:(nrow(abs_tab) - 1)) {
  for (j in (i + 1):nrow(abs_tab)) {
    # Extract values
    a <- abs_tab[i, "yes"]
    b <- abs_tab[j, "yes"]
    N1 <- sum(abs_tab[i, ])
    N0 <- sum(abs_tab[j, ])
    
    # Compute risk difference
    rd <- riskdifference(a, b, N1, N0)
    
    # Store results
    risk_diff_results <- rbind(risk_diff_results, data.frame(
                                Pathogen1 = pathogens[i],
                                Pathogen2 = pathogens[j],
                                RiskDifference = rd$estimate,
                                CI_Lower = rd$conf.int[1],
                                CI_Upper = rd$conf.int[2],
                                p_value = rd$p.value
                              ))
  }
}

jpeg("../../mcid3_DK/Draft/risk_diff_absences.jpeg",
     width = 16, height = 12, units = "cm",
     res = 1000
)
risk_diff_results %>% 
  mutate(
    Pathogen1 = factor(Pathogen1, levels = rev(pathgs), labels = rev(pathgs.labels)),
    Pathogen2 = factor(Pathogen2, levels = rev(pathgs), labels = rev(pathgs.labels)),
  ) %>%
  mutate(
    rd_sign = paste0(round(RiskDifference,2) * 100, signif_code(p_value))
  ) %>%
  ggplot(aes(x = Pathogen1, y = Pathogen2, fill = RiskDifference)) +
  geom_tile() +
  geom_text(aes(label = paste0(round(RiskDifference,1), signif_code(p_value))), size = 2.8) +
  theme_minimal(base_size = 14) +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
  labs(x = "", y = "") +
  theme(
    axis.text.x = element_text(size = 8, angle = 0, hjust = 0.5),
    axis.text.y = element_text(size = 8, margin = margin(r = -5)),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),
    legend.position = "none",
    title = element_text(size = 8, face = "bold"),
    plot.margin = margin(0, 0, 0, 0)
  )
dev.off()
```


```{r}
## Compare proportion of absences of IFB with other respiratory viruses
##------------------------------------------------------------------------------
abs_ifb_v_other <- infections_imp %>%
    filter(!is.na(pathogen)) %>%
    group_by(infection_id) %>%
    slice(1) %>%
    ungroup() %>%
    mutate(
        absence_time = as.numeric(difftime(date_return, date_absent, units = "days")),
        absence = factor(case_when(
            absence_time > 0 ~ "yes",
            TRUE ~ "no"
        ), levels = c("no", "yes")),
        pathogen = factor(case_when(
          pathogen == "IFB" ~ "IFB",
          TRUE ~ "other"
        ), levels = c("other", "IFB"))
    ) %>%
  dplyr::select(pathogen, absence) %>% 
  table() %>%
  twoby2()
  
```


## Supplements: Survival analysis for days absent

```{r}
## Survival analysis for days absent #------------------------------------------
# Parametric model (gompertz distr. -> proportional hazards)
surv_absences_2 <- surv_absences %>%
   filter(!is.na(pathogen)) 

abs_par <- flexsurvreg(Surv(absence_time + possible, absence_time, 
                            type = "interval2") ~ pathogen, 
                       data = surv_absences_2 %>% mutate(
                         pathogen = relevel(pathogen, ref = "RSV") # reference category
                       ),
                       dist = "gompertz")

# Summary table
tidy(abs_par, conf.int = TRUE, transform = "coefs.exp") # p-values

# Prediction for each pathogen
new.data <- data.frame(pathogen = factor(c("IFA", "IFB", "HRV", "AdV", 
                                           "PIV", "RSV", "HCoV-OC43"),
                                         levels = c("IFA", "IFB", "HRV", 
                                                    "AdV", "PIV", "RSV", 
                                                    "HCoV-OC43")))
# Graphical display
jpeg("../../mcid3_DK/Draft/S3_survival_absent_days.jpeg",
     width = 16, height = 12, units = "cm",
     res = 1000
)
par(las = 1, xaxs = "i", yaxs = "i",
     mgp = c(2.5, 1, 0),
     mar = c(4.1, 3.8, 0.5, 0.5))
plot(abs_par, newdata = new.data,
     col = cols[levels(new.data$pathogen)], 
     col.obs = rgb(0, 0, 0, alpha = 0),
     t = seq(0, 15, by = 0.01),
     xlab = "Days since first absence", ylab = "Probability of being absent (%)",
     lwd = 2, main = "",
     yaxt = "n",
     cex.lab = 0.8)
axis(side = 2, at = seq(0, 1, by = 0.2), labels =seq(0, 1, by = 0.2) * 100)
legend(x = "topright", col = cols[levels(new.data$pathogen)], 
       cex = 0.8,
       legend = pathgs.labels[-8],
       lwd = 2)
dev.off()

## Survival analysis for days absent comparing IFB to other viruses
abs_par_ifb_v_other <- flexsurvreg(Surv(absence_time + possible, absence_time, 
                            type = "interval2") ~ pathogen, 
                       data = surv_absences_2 %>% mutate(
                         pathogen = factor(case_when(
                           pathogen == "IFB" ~ "IFB",
                           TRUE ~ "other"
                         ), levels = c("other", "IFB"))
                       ),
                       dist = "gompertz")
tidy(abs_par_ifb_v_other) %>%
  pull(estimate) %>% exp() %>% round(2)
predict(abs_par_ifb_v_other, type = "quantile", p = 0.5, conf.int = T,
        newdata = data.frame(pathogen = c("IFB", "other")))
```

# Figure 3c: Absence periods confidence intervals

```{r}
## 95%-confidence intervals length of absence periods by respiratory virus #----
figure_3c <- data.frame(
  # Confidence intervals for prediction from survival model
  cbind(predict(abs_par, newdata = new.data, type = "quantile", p = 0.5, conf.int = T), 
        new.data$pathogen)
  ) %>%
  # Truncation for plot, as this is a conditional absence time, so it must be at least
  # 1 day long
  mutate(.pred_lower = ifelse(.pred_lower < 1, 1, .pred_lower)) %>%
  # Include HCoV-229E, for which no absence period with symptoms recorded, on x-axis, without values
  bind_rows(
    data.frame(
      .pred_quantile = NA,
      .pred_lower = NA,
      .pred_upper = NA,
      new.data.pathogen = "HCoV-229E"
    )
  ) %>%
  # Arrange for consistent ordering in plot
  mutate(new.data.pathogen = factor(new.data.pathogen, 
                                   levels = pathgs,
                                   labels = pathgs.labels)) %>%
  # Plotting
  ggplot(aes(x = new.data.pathogen, y = .pred_quantile, col = new.data.pathogen)) +
  # Errorbars
  geom_errorbar(aes(ymin = .pred_lower, ymax = .pred_upper),
                width = 0.4, size = 1) + 
  # Add estimates of CI boundaries above/below errorbars
  geom_text(aes(y = .pred_upper + 0.3, 
                label = round(.pred_upper, 1)), size = 3.2) +
  geom_text(aes(y = .pred_lower - 0.3, 
                label = round(.pred_lower, 1)), size = 3.2) +
  # Add tiles for point estimates
  geom_tile(aes(width = 0.4, height = 0.6), 
            size = 0.9, fill = "white", color = cols) +
  # Add point estimates within squares (rounded to 1 decimal)
  geom_text(aes(label = round(.pred_quantile, 1)), size = 3.2) +
  # Formatting 
  scale_color_manual(values = cols.labels) +
  theme_classic() +
  labs(
    x = "", y = "Absence period (days)",
    title = "c"
  ) + 
  ylim(NA, 8) +
  scale_y_continuous(breaks = seq(1, 7, by = 2)) +
  theme(
    axis.text.x = element_text(size = 8, angle = 0, hjust = 0.5),
    axis.title.y = element_text(size = 8, face = "plain"),
    legend.position = "none",
    title = element_text(size = 8, face = "bold")
  )
```

## Supplements: Boxplot for length of positivity periods

```{r}
## Length of interval-censored positivity period by respiratory virus #---------
boxplot_pp <- pos_periods %>%
  filter(!is.na(pathogen)) %>%
  mutate(pathogen = factor(pathogen, levels = pathgs,
                           labels = pathgs.labels)) %>%
  ggplot(aes(pathogen, observed + possible, fill = pathogen)) +
  geom_boxplot() +
  scale_color_manual(values = cols.labels) +
  scale_fill_manual(values = cols.labels) +
  labs(
    x = "", y = "Duration of detection (days)",
    title = ""
  ) +
  theme_classic() +
  theme(
    legend.position = "none",
    title = element_text(hjust = 0, face = "bold", size = 8),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 8),
    axis.title.y = element_text(size = 8, hjust = 0.5,
                                face = "plain")
  ) +
    scale_y_continuous(breaks = c(1,10,20,30))

jpeg("../../mcid3_DK/Draft/S2_boxplot_PPs.jpeg", 
     width = 16, height = 10,
     units = 'cm', res = 1000)
boxplot_pp
dev.off()
```

## Supplements: Survival Analysis for Positivity Periods

```{r}  
## Model the length of the positivity period #----------------------------------
# Censoring indicator: 0 = right-censored, 1 = observed, 3 = interval-censored
# Observed: observed length of positivity period
# Possible: possible length of positivity period, no saliva sampling due to absences

# Definition of censoring indicator
# Right-censored if at beginning or end of the study
SurvDataPP <- pos_periods %>%
  mutate(
    pathogen = factor(pathogen, levels = pathgs),
    pathogen = relevel(pathogen, ref = "HCoV-229E"),
  censoring_indicator = case_when(
    possible > 0 ~ 3,
    TRUE ~ 1
  ),
  possible = ifelse(censoring_indicator == 3, possible, 0)) %>%
  dplyr::select(censoring_indicator, observed, possible, pathogen)

## Overall duration of detection length
mod.overall <-  flexsurvreg(Surv(time = observed,
                           time2 = observed + possible,
                           event = censoring_indicator,
                           type = "interval") ~ 1, 
                      data = SurvDataPP, dist = "gompertz")
predict(mod.overall, conf.int = T, type = "quantile", p = 0.5)[1,]

# Parametric model (gompertz distribution -> proportional hazards)
mod.PP <- flexsurvreg(Surv(time = observed,
                           time2 = observed + possible,
                           event = censoring_indicator,
                           type = "interval") ~ pathogen, 
                      data = SurvDataPP, dist = "gompertz")

# Summary table (supplements)
tidy(mod.PP, conf.int = TRUE, transform = "coefs.exp") # p-values

# Prediction for each pathogen
new.data <- data.frame(pathogen = factor(pathgs, levels = pathgs))

# Confidence intervals for prediction of absence period length
set.seed(910)
pp_predicted_ci <- data.frame(cbind(predict(mod.PP, newdata = new.data,
                                            conf.int = T, type = "quantile",
                                            p = 0.5),
                                    new.data$pathogen)
                              )
# Results text
round(pp_predicted_ci[pp_predicted_ci$new.data.pathogen == "IFB", 1:3],2)

# Graphical display
jpeg("../../mcid3_DK/Draft/S2_survival_positivityperiod.jpeg",
     width = 16, height = 12, units = "cm",
     res = 1000
)
par(las = 1, xaxs = "i", yaxs = "i",
     mgp = c(2.5, 1, 0),
     mar = c(4.1, 3.8, 0.5, 0.5))
plot(mod.PP, newdata = new.data, 
     col = cols[levels(new.data$pathogen)], 
     col.obs = rgb(0, 0, 0, alpha = 0),
     t = seq(0, 22, by = 0.01),
     xlab = "Days since first positive test", ylab = "Probability of being positive (%)",
     lwd = 2, main = "",
     yaxt = "n",
     cex.lab = 0.8)
axis(side = 2, at = seq(0, 1, by = 0.2), labels =seq(0, 1, by = 0.2) * 100)
legend(x = "topright", col = cols[levels(new.data$pathogen)], 
       cex = 0.8,
       legend = pathgs.labels,
       lwd = 2)
dev.off()
```

# Figure 3a: Cofidence intervals of estimated positivity periods

```{r}
## Plot 95% confidence intervals for lengths of estimated positivity periods #--
figure_3a <- pp_predicted_ci %>%
  # Arrange for consistent ordering in plot
  mutate(new.data.pathogen = factor(new.data.pathogen,
                                    levels = pathgs,
                                    labels = pathgs.labels)) %>%
  # Plotting
  ggplot(aes(x = new.data.pathogen, y = .pred_quantile, col = new.data.pathogen)) +
  # Errorbars
  geom_errorbar(aes(ymin = .pred_lower, ymax = .pred_upper),
                width = 0.4, size = 1) +
  # Add estimates of CI boundaries above/below errorbars
  geom_text(aes(y = .pred_upper + 0.9,
                label = round(.pred_upper, 1)), size = 3.2) +
  geom_text(aes(y = .pred_lower - 0.9,
                label = round(.pred_lower, 1)), size = 3.2) +
  # Add tiles for point estimates
  geom_tile(aes(width = 0.4, height = 1.6),
            size = 0.9, fill = "white", color = cols) +
  # Add point estimates within squares (rounded to 1 decimal)
  geom_text(aes(label = round(.pred_quantile, 1)), size = 3.2) +
  # Formatting
  scale_color_manual(values = cols.labels) +
  theme_classic() +
  labs(
    x = "", y = "Duration of detection (days)",
    title = "a"
  ) +
  # ylim(NA, NA) +
  scale_y_continuous(breaks = seq(1, 16, by = 3)) +
  theme(
    axis.text.x = element_text(size = 8, angle = 0, hjust = 0.5),
    axis.title.y = element_text(size = 8, face = "plain"),
    legend.position = "none",
    title = element_text(size = 8, face = "bold")
  )

## Save Figure 3 #--------------------------------------------------------------
jpeg("../../mcid3_DK/Draft/figure3.jpeg",
     width = 18, height = 18,
     units = 'cm', res = 1000)
figure_3a/figure_3b/figure_3c +
  theme(
        plot.margin = margin(t = 0, r = 0, b = 0, l = 0))
dev.off()

# Save as .tif
tiff("../../mcid3_DK/Draft/after_review/figures_tif/figure3.tif",
     width = 18, height = 18, units = "cm", res = 1000)
figure_3a/figure_3b/figure_3c +
  theme(
        plot.margin = margin(t = 0, r = 0, b = 0, l = 0))
dev.off()
```


# Figure 4: Radar plots of self-reported symptoms by pathogen

```{r}
## Radar plots of self-reported symptoms by pathogen #--------------------------
# Apply normalization function to each column except "pathogen"
symptoms_scaled <- symptoms %>%
  mutate(across(-pathogen, normalize),
         pathogen = factor(pathogen, levels = pathgs)) %>%
  arrange(pathogen)

# Create radar charts for each pathogen
spider <- list()
for (i in 1:nrow(symptoms_scaled)) {
  radar_plot <- ggradar(symptoms_scaled[i,], group.colours = cols[i],
                        group.point.size = 1,
                        grid.min = 0, grid.mid = 0.5, grid.max = 1,
                        base.size = 0.1,
                        grid.label.size = 3,
                        axis.label.size = 2.8,
                        axis.label.offset = 1.2,
                        gridline.label.offset = 0.1,
                        gridline.mid.colour = "gray",
                        plot.extent.x.sf = 2.1,
                        fill = TRUE,
                        group.line.width = 0.5,
                        fill.alpha = 0.5,
                        axis.labels = c("Fever", "Chills", 
                                        "Limb pain", 
                                        "Loss of taste", 
                                        "Loss of smell", 
                                        "Fatigue", "Cough",
                                        "Runny nose", "Diarrhea",
                                        "Sore throat", "Headache", 
                                        "Shortness of breath", 
                                        "Stomach pains")) +
    theme(
      legend.position = "none",
      plot.title = element_text(size = 8, face = "bold", hjust = 0.5),
      axis.text = element_text(size = 6),
      panel.grid = element_blank()
    )
  
  # Create a title grob
  title_grob <- textGrob(pathgs.labels[i], gp = gpar(fontsize = 8, fontface = "bold"))
  
  # Arrange the title and the plot with adjusted spacing
  combined_plot <- arrangeGrob(
    title_grob,
    radar_plot,
    ncol = 1,
    heights = unit.c(grobHeight(title_grob) + ggplot2::unit(0.1, "line"), ggplot2::unit(1, "npc") - 4*grobHeight(title_grob) - ggplot2::unit(0.1, "line"))
  )
  
  spider[[i]] <- combined_plot
}

# HCoV-229E (no matched absence, hence no symptoms recorded)
radar_plot_8 <- data.frame(
  pathogen = "HCoV-229E",
  fever = 0, chills = 0, limb_pain = 0, loss_of_taste = 0, loss_of_smell = 0,
  fatigue = 0, cough = 0, cold = 0, diarrhea = 0, sore_throat = 0,
  headache = 0, shortness_of_breath = 0, stomach_pains = 0
) %>%
  ggradar(group.colours = "lightgray",
          group.point.size = 0,
          grid.min = 0, grid.mid = 0.5, grid.max = 1,
          base.size = 0.000001,
          grid.label.size = 3,
          axis.label.size = 2.8,
          gridline.label.offset = 0.0001,
          gridline.mid.colour = "gray",
          plot.extent.x.sf = 2.1,
          fill = TRUE,
          group.line.width = 0.000000001,
          fill.alpha = 0,
          axis.labels = c("Fever", "Chills", "Limb pain", 
                          "Loss of taste", 
                          "Loss of smell", "Fatigue", "Cough",
                          "Runny nose", "Diarrhea",
                          "Sore throat", "Headache", 
                          "Shortness of breath", 
                          "Stomach pains")) +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 8, face = "bold", hjust = 0.5),
    axis.text = element_text(size = 6),  
    panel.grid = element_blank()
  )


title_grob_8 <- textGrob("HCoV-229E", gp = gpar(fontsize = 8, fontface = "bold"))

combined_plot_8 <- arrangeGrob(
  title_grob_8,
  radar_plot_8,
  ncol = 1,
  heights = unit.c(grobHeight(title_grob_8) + ggplot2::unit(0.1, "line"), ggplot2::unit(1, "npc") - 4*grobHeight(title_grob) - ggplot2::unit(0.1, "line"))
)

spider[[8]] <- combined_plot_8

## Save Figure 4 #--------------------------------------------------------------
jpeg("../../mcid3_DK/Draft/figure4.jpeg", width = 18, 
     height = 20, units = 'cm', res = 1000)
gridExtra::grid.arrange(grobs = spider, ncol = 2)
dev.off()

# Save as .tif
tiff("../../mcid3_DK/Draft/after_review/figures_tif/figure4.tif",
     width = 18, height = 20, units = "cm", res = 1000)
gridExtra::grid.arrange(grobs = spider, ncol = 2)
dev.off()

```

## Supplements: Hierarchical Clustering by Self-Reported Symptoms

```{r}
## Hierarchical clustering #----------------------------------------------------
# detect which pathogens are similar in self-reported symptoms
par(las = 1)
symptoms_hc <- symptoms %>%
  mutate(pathogen = factor(pathogen, levels = pathgs, labels = pathgs.labels)) %>%
  column_to_rownames(var = "pathogen") %>%
  dist(method = "euclidian") %>%
  hclust(method = "complete")

jpeg("../../mcid3_DK/Draft/S4_cluster_symptoms.jpeg", width = 16, 
     height = 12, units = 'cm', res = 1000)
plot(as.dendrogram(symptoms_hc), main = "",
     xlab = "", ylab = "Distance", col = "black")
dev.off()
```

## Fisher's exact test: Gender and respiratory viruses

```{r}
## Fishers exact test for association between gender and respiratory viruses #--
# Infectious periods are only be counted once
set.seed(910)
fisherTestData <- infections_imp %>%
  group_by(infection_id) %>%
  slice(1) %>%
  ungroup() %>%
 left_join(soc_data %>% filter(time == "Baseline") %>% 
             dplyr::select(Class, sex, student_id),
           by = "student_id")
tab.fish.gen <- table(fisherTestData$sex, 
                      fisherTestData$pathogen)
fisher.test(tab.fish.gen, simulate.p.value = TRUE)
```

## Fisher's exact test: Class and positivity periods

```{r warning=FALSE, message=FALSE}
## Fishers exact test for association between class and respiratory viruses #---
tab.fish.class <- table(fisherTestData$Class,
                        fisherTestData$pathogen)
# Fisher's exact test for 4x8 contigency table
fisher.test(tab.fish.class, simulate.p.value = TRUE)
```

## Description of positivity periods

```{r}
## Number of infectious periods with only one positive test #-------------------
# infectious_periods_IC %>%
#   group_by(infectious_period) %>%
#   # Filter for groups containing only one row
#   filter(n() == 1) %>%
#   ungroup() %>%
#   { 
#     cat("Number of infectious periods with only one positive test:", nrow(.), "\n")
#   }
#   
# ## Number of infectious periods with 2 positive tests #-------------------------
# infectious_periods_IC %>%
#   group_by(infectious_period) %>%
#   # Filter for groups containing more than one row
#   filter(n() == 2) %>%
#   filter(row_number() == 1) %>%
#   ungroup() %>%
#   { 
#     cat("Number of infectious periods with two positive tests:", nrow(.), "\n")
#   }
# 
# ## Number of infectious periods with 3 or more positive tests #-----------------
# infectious_periods_IC %>%
#   group_by(infectious_period) %>%
#   # Filter for groups containing more than one row
#   filter(n() >= 3) %>%
#   filter(row_number() == 1) %>%
#   ungroup() %>%
#   { 
#     cat("Number of infectious periods with three or more positive tests:", nrow(.), "\n")
#   }
# 
# ## All infectious period of length 8 positive tests #---------------------------
# infectious_periods_IC %>%
#   group_by(infectious_period) %>%
#   # Filter for groups containing more than one row
#   filter(n() == 8) %>%
#   filter(row_number() == 1) %>%
#   ungroup() %>%
#   { 
#     cat("Number of infectious periods with eight positive tests:", nrow(.), "\n")
#     cat("Pathogen:", pathgs[unique(.$pathogen)], "\n")
#   }
# 
# ## All infectious period of length 6 positive tests #---------------------------
# infectious_periods_IC %>%
#   group_by(infectious_period) %>%
#   # Filter for groups containing more than one row
#   filter(n() >= 6) %>%
#   filter(row_number() == 1) %>%
#   ungroup() %>%
#   { 
#     cat("Number of infectious periods with seven positive tests:", nrow(.), "\n")
#     cat("Pathogen:", pathgs[(.$pathogen)], "\n")
#   }

## All coinfectious periods #----------------------------------------
# Number of coninfections
infections_imp %>%
  filter(!is.na(pathogen)) %>%
  group_by(infection_id) %>%
  slice(1) %>%
  ungroup() %>%
  group_by(student_id) %>%
  filter(n() > 1) %>%
  # For each student, count the number of coinfections
  # For all pairwise rows, check whether date_first_sample or date_last_sample is
  # within the interval of the other row


# Number of coinfections
infectious_periods_IC %>%
  group_by(student_id, time_id) %>%
  filter(n() > 1) %>%
  ungroup() %>%
  pull(student_id) %>%
  unique() %>%
  length()

# Display coinfections
infectious_periods_IC %>%
  group_by(student_id, time_id) %>%
  filter(n() > 1) %>%
  ungroup() %>%
  dplyr::select(student_id, time_id, pathogen) %>%
  distinct() %>%
  arrange(student_id, time_id)

# Infectious episodes by class
infectious_periods_IC %>%
  mutate(class = substr(student_id, 1, 1)) %>%
  group_by(class) %>%
  summarise(n = n_distinct(infectious_period))

```


